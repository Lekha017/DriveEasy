<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - DriveEasy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f5a623;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.show {
      display: flex;
    }

    .toast.success {
      border-left: 4px solid #4caf50;
    }

    .toast.error {
      border-left: 4px solid #f44336;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f5a623 0%, #f7b946 100%);
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .logo span {
      color: #e85d04;
    }

    nav {
      display: flex;
      gap: 10px;
    }

    nav a {
      padding: 10px 20px;
      text-decoration: none;
      color: #333;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    nav a:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    nav a.active {
      background: rgba(255, 255, 255, 0.5);
    }

    .logout-btn {
      background: #e85d04;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #d04d04;
      transform: scale(1.05);
    }

    .section {
      display: none;
      padding: 30px 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: bold;
      color: #f5a623;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin: 15px 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      margin-bottom: 20px;
      color: #333;
      border-bottom: 3px solid #f5a623;
      padding-bottom: 10px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 12px;
      text-align: left;
    }

    th {
      background: linear-gradient(135deg, #f5a623 0%, #f7b946 100%);
      color: #333;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    tr:hover {
      background: #fff3e0;
    }

    .status-pending {
      background: #ff9800;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
    }

    .status-approved {
      background: #4caf50;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
    }

    .status-rejected {
      background: #f44336;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
    }

    .action-btn {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 2px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .reject-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .reject-btn:hover {
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .close-modal {
      float: right;
      cursor: pointer;
      font-size: 28px;
      font-weight: bold;
      color: #999;
      transition: color 0.3s;
    }

    .close-modal:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group select:focus {
      outline: none;
      border-color: #f5a623;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    @media (max-width: 768px) {
      nav {
        display: none;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast">
    <span id="toastIcon"></span>
    <div id="toastMessage"></div>
  </div>

  <header>
    <div class="logo">Drive<span>Easy</span></div>
    <nav>
      <a onclick="showSection('home')" class="active">Dashboard</a>
      <a onclick="showSection('manage-bookings')">Bookings</a>
      <a onclick="showSection('manage-users')">Users</a>
      <a onclick="showSection('manage-instructors')">Instructors</a>
    </nav>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <section id="home" class="section active">
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Active Learners</h3>
        <div class="value" id="activeLearners">0</div>
      </div>
      <div class="stat-card">
        <h3>Classes Booked</h3>
        <div class="value" id="classesBooked">0</div>
      </div>
      <div class="stat-card">
        <h3>Pending Bookings</h3>
        <div class="value" id="pendingBookings">0</div>
      </div>
      <div class="stat-card">
        <h3>Approved Bookings</h3>
        <div class="value" id="approvedBookings">0</div>
      </div>
    </div>
  </section>

  <section id="manage-bookings" class="section">
    <div class="card">
      <h2>Booking Management</h2>
      <div class="table-container">
        <table id="bookingsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Contact</th>
              <th>Date</th>
              <th>Time Slot</th>
              <th>Instructor</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="manage-users" class="section">
    <div class="card">
      <h2>User Management</h2>
      <div class="table-container">
        <table id="usersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Registered</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="manage-instructors" class="section">
    <div class="card">
      <h2>Instructor Management</h2>
      <div class="table-container">
        <table id="instructorsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>License</th>
              <th>Experience</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="modal" id="approveModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Approve Booking</h3>
      <p id="bookingDetails" style="margin-bottom: 20px; color: #666;"></p>
      <div class="form-group">
        <label>Assign Instructor:</label>
        <select id="instructorAssign">
          <option value="">Select Instructor</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="action-btn" onclick="confirmApprove()">Approve & Notify</button>
        <button class="action-btn reject-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentBookingId = null;

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      const icons = { success: '✓', error: '✕' };
      toast.className = `toast show ${type}`;
      icon.textContent = icons[type] || 'ℹ';
      msg.textContent = message;

      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));

      document.getElementById(sectionId).classList.add('active');
      event.target.classList.add('active');

      if (sectionId === 'manage-bookings') loadBookings();
      if (sectionId === 'manage-users') loadUsers();
      if (sectionId === 'manage-instructors') loadInstructors();
    }

    async function loadStats() {
      try {
        const res = await fetch("https://backend-production-e9e9.up.railway.app/stats", { credentials: "include" });
        const stats = await res.json();

        document.getElementById("activeLearners").textContent = stats.activeLearners;
        document.getElementById("classesBooked").textContent = stats.classesBooked;
        document.getElementById("pendingBookings").textContent = stats.pendingBookings;
        document.getElementById("approvedBookings").textContent = stats.approvedBookings || 0;
      } catch (err) {
        console.error("Stats Error:", err);
        showToast("Failed to load statistics", "error");
      }
    }

    async function loadBookings() {
      showLoading();
      try {
        const res = await fetch("https://backend-production-e9e9.up.railway.app/admin/bookings", { credentials: "include" });
        const bookings = await res.json();
        const tbody = document.querySelector("#bookingsTable tbody");
        tbody.innerHTML = "";

        if (bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px;">No bookings found</td></tr>';
          return;
        }

        bookings.forEach(booking => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${booking.id}</td>
        <td>${booking.user_name}<br><small style="color:#666;">${booking.user_email}</small></td>
        <td>${booking.contact}</td>
        <td>${new Date(booking.date).toLocaleDateString()}</td>
        <td>${booking.time_slot}</td>
        <td>${booking.instructor_name || '<em>Not Assigned</em>'}</td>
        <td><span class="status-${booking.status}">${booking.status.toUpperCase()}</span></td>
        <td>
          ${booking.status === 'pending' ? `
            <button class="action-btn" onclick="openApproveModal(${booking.id}, '${booking.user_name}', '${booking.date}', '${booking.time_slot}')">Approve</button>
            <button class="action-btn reject-btn" onclick="rejectBooking(${booking.id})">Reject</button>
          ` : '-'}
        </td>
      `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Bookings Error:", err);
        showToast("Failed to load bookings", "error");
      } finally {
        hideLoading();
      }
    }

    async function loadUsers() {
      showLoading();
      try {
        const res = await fetch("https://backend-production-e9e9.up.railway.app/users", { credentials: "include" });
        const users = await res.json();
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">No users found</td></tr>';
          return;
        }

        users.forEach(user => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${user.id}</td>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td><span style="background:#e3f2fd;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">${user.role}</span></td>
        <td>${new Date(user.created_at).toLocaleString()}</td>
      `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Users Error:", err);
        showToast("Failed to load users", "error");
      } finally {
        hideLoading();
      }
    }

    async function loadInstructors() {
      showLoading();
      try {
        const res = await fetch("https://backend-production-e9e9.up.railway.app/instructors", { credentials: "include" });
        const instructors = await res.json();
        const tbody = document.querySelector("#instructorsTable tbody");
        tbody.innerHTML = "";

        if (instructors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">No instructors found</td></tr>';
          return;
        }

        instructors.forEach(inst => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${inst.id}</td>
        <td>${inst.name}</td>
        <td>${inst.email}</td>
        <td>${inst.license_id}</td>
        <td>${inst.experience}</td>
        <td><span class="status-${inst.status === 'available' ? 'approved' : 'pending'}">${inst.status}</span></td>
      `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Instructors Error:", err);
        showToast("Failed to load instructors", "error");
      } finally {
        hideLoading();
      }
    }

    async function openApproveModal(bookingId, userName, date, timeSlot) {
      currentBookingId = bookingId;
      document.getElementById("bookingDetails").textContent =
        `User: ${userName} | Date: ${new Date(date).toLocaleDateString()} | Time: ${timeSlot}`;

      const res = await fetch("https://backend-production-e9e9.up.railway.app/instructors", { credentials: "include" });
      const instructors = await res.json();

      const select = document.getElementById("instructorAssign");
      select.innerHTML = '<option value="">Select Instructor</option>';

      instructors.forEach(inst => {
        const option = document.createElement("option");
        option.value = inst.id;
        option.textContent = `${inst.name} (${inst.status})`;
        select.appendChild(option);
      });

      document.getElementById("approveModal").classList.add("show");
    }

    async function confirmApprove() {
      const instructorId = document.getElementById("instructorAssign").value;

      if (!instructorId) {
        showToast("Please select an instructor", "error");
        return;
      }

      showLoading();
      try {
        const res = await fetch(`https://backend-production-e9e9.up.railway.app/admin/bookings/${currentBookingId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ status: 'approved', instructor_id: instructorId })
        });

        const data = await res.json();
        showToast(data.message, "success");
        closeModal();
        loadBookings();
        loadStats();
      } catch (err) {
        console.error("Approve Error:", err);
        showToast("Failed to approve booking", "error");
      } finally {
        hideLoading();
      }
    }

    async function rejectBooking(bookingId) {
      if (!confirm("Are you sure you want to reject this booking?")) return;

      showLoading();
      try {
        const res = await fetch(`https://backend-production-e9e9.up.railway.app/admin/bookings/${bookingId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ status: 'rejected' })
        });

        const data = await res.json();
        showToast(data.message, "success");
        loadBookings();
        loadStats();
      } catch (err) {
        console.error("Reject Error:", err);
        showToast("Failed to reject booking", "error");
      } finally {
        hideLoading();
      }
    }

    function closeModal() {
      document.getElementById("approveModal").classList.remove("show");
      currentBookingId = null;
    }

    function logout() {
      showLoading();
      fetch("https://backend-production-e9e9.up.railway.app/logout", {
        method: "POST",
        credentials: "include"
      }).then(() => {
        showToast("Logged out successfully", "success");
        setTimeout(() => window.location.href = "Home.html", 1000);
      }).finally(() => hideLoading());
    }

    window.onload = () => {
      loadStats();
      loadBookings();
    };
  </script>
</body>

</html>